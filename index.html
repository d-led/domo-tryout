<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <title>DomoActors</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <link href="style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid mt-5">
      <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
          <div class="text-center mb-4">
            <h5 class="mb-4">
              Trying out
              <a
                href="https://github.com/VaughnVernon/DomoActors"
                class="text-decoration-none"
                target="_blank"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="currentColor"
                  style="vertical-align: -2px; margin-right: 4px"
                >
                  <path
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
                  /></svg
                >github.com/VaughnVernon/DomoActors
              </a>
              in the browser â†’
              <a
                href="https://github.com/d-led/domo-tryout"
                class="text-decoration-none"
                target="_blank"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="currentColor"
                  style="vertical-align: -2px; margin-right: 4px"
                >
                  <path
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
                  /></svg
                >This Demo
              </a>
            </h5>
            <div class="row">
              <div class="col-md-6 mb-4">
                <h6 class="text-muted mb-2">Local Counter</h6>
                <h1 class="display-1 mb-4" id="count">0</h1>
                <button
                  class="btn btn-danger btn-lg"
                  onclick="counter.decrement()"
                >
                  -
                </button>
              </div>
              <div class="col-md-6 mb-4">
                <h6 class="text-muted mb-2">
                  Synced Counter <small>(shared across users)</small>
                  <span class="badge bg-info" id="peer-count">0</span>
                  <small>peer(s)</small>
                  <span
                    id="connection-status"
                    class="ms-3"
                    title="Connection status"
                    style="display: inline-block"
                  ></span>
                </h6>
                <h1 class="display-1 mb-4" id="synced-count">0</h1>
                <button
                  class="btn btn-danger btn-lg"
                  onclick="syncedCounter.decrement()"
                >
                  -
                </button>
              </div>
            </div>
          </div>

          <div class="window">
            <div class="window-header">
              <div class="window-dot dot-red"></div>
              <div class="window-dot dot-yellow"></div>
              <div class="window-dot dot-green"></div>
              <div class="window-title">src/Counter.ts</div>
            </div>
            <div class="window-body">
              <pre><code class="language-typescript" id="counter-interface-code">Loading...</code></pre>
            </div>
          </div>

          <div class="window mt-3">
            <div class="window-header">
              <div class="window-dot dot-red"></div>
              <div class="window-dot dot-yellow"></div>
              <div class="window-dot dot-green"></div>
              <div class="window-title">src/index.ts</div>
            </div>
            <div class="window-body">
              <pre><code class="language-typescript" id="source-code">Loading...</code></pre>
            </div>
          </div>

          <div class="window mt-3">
            <div class="window-header">
              <div class="window-dot dot-red"></div>
              <div class="window-dot dot-yellow"></div>
              <div class="window-dot dot-green"></div>
              <div class="window-title">index.html (button)</div>
            </div>
            <div class="window-body">
              <pre><code class="language-html">&lt;button class="btn btn-danger btn-lg" onclick="counter.decrement()"&gt;-&lt;/button&gt;</code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="extract-embedded.js"></script>
    <script>
      const extractEmbedded = ExtractEmbedded.extractEmbedded;

      fetch("Counter.ts")
        .then((r) => r.text())
        .then((code) => {
          const el = document.getElementById("counter-interface-code");
          el.textContent = code;
          Prism.highlightElement(el);
        });
      fetch("index.ts")
        .then((r) => r.text())
        .then((code) => {
          const el = document.getElementById("source-code");
          el.textContent = extractEmbedded(code);
          Prism.highlightElement(el);
        });
    </script>
    <script src="bundle.js"></script>
    <footer class="text-center mt-5 mb-3 text-muted small">
      <div>Server version: <span id="server-version">loading...</span></div>
      <div>Client version: _unknown_</div>
    </footer>
    <script>
      // Fetch server version on load
      // Use the same server URL as the WebSocket connection (exposed from synced-counter.ts)
      function fetchServerVersion() {
        const wsServer = window.wsServerUrl || "ws://localhost:9870";
        if (!wsServer) {
          document.getElementById("server-version").textContent = "unavailable";
          return;
        }
        // Convert ws:// to http:// or wss:// to https:// for the /version endpoint
        let httpServer = wsServer
          .replace(/^ws:/, "http:")
          .replace(/^wss:/, "https:");
        // Extract just the hostname and port/protocol, remove any path
        try {
          const url = new URL(httpServer);
          // Reconstruct URL with just protocol, hostname, port, and /version path
          const versionUrl = `${url.protocol}//${url.hostname}${url.port ? ":" + url.port : ""}/version`;
          fetch(versionUrl)
            .then((r) => r.text())
            .then((v) => {
              const el = document.getElementById("server-version");
              if (el) el.textContent = v || "unknown";
            })
            .catch(() => {
              const el = document.getElementById("server-version");
              if (el) el.textContent = "unavailable";
            });
        } catch (e) {
          const el = document.getElementById("server-version");
          if (el) el.textContent = "unavailable";
        }
      }

      // Wait for bundle.js to load and expose wsServerUrl
      if (window.wsServerUrl) {
        fetchServerVersion();
      } else {
        // Wait a bit for the bundle to load
        setTimeout(fetchServerVersion, 500);
      }
    </script>
  </body>
</html>
